# Gemini CLI GUI Wrapper（Windows向け）仕様書（MVP〜v1）

## 1. 目的
初心者がCLIを使わずに、チャットUIから安全にローカルファイル操作を実行できるWindowsアプリを提供する。
内部では Google の Gemini CLI を利用し、ユーザーは「会話→提案→承認→実行」という流れで操作できる。

## 2. 想定ユーザー
- Windows初心者（CLIに抵抗がある）
- ローカルのフォルダ整理、テキスト編集、名前変更、検索、置換などを対話で行いたい人
- GitHubからインストーラをダウンロードして使う人

## 3. スコープ
### 3.1 対応OS
- Windows 10 / 11（64bit）

### 3.2 対象フォルダ制限（最重要）
- ユーザーがアプリ上で選択した「ワークスペースフォルダ」配下のみ操作可能
- ワークスペース外のパスは一切アクセス不可（読み取り・書き込み・列挙・削除すべて禁止）
- シンボリックリンク / ジャンクションでの脱出を防ぐ（後述）

### 3.3 対応するファイル操作（指定フォルダ内のみ）
- 参照: ファイル一覧、内容表示（テキスト/バイナリ判定）
- 作成: 新規ファイル/フォルダ作成
- 更新: テキスト編集、検索/置換、追記、移動、リネーム
- 削除: ファイル/フォルダ削除（確認必須）
- 複製: コピー
- 圧縮/展開: zip の作成・展開（確認必須）
- 検索: ファイル名検索、内容検索（簡易正規表現は任意）
- 差分: テキストファイルはdiff表示（必須）

※ 実行ファイルの実行（.exe/.bat/.ps1 等）や外部コマンド実行は v1 では禁止（後述の安全設計）

## 4. 非スコープ（v1ではやらない）
- ワークスペース外の操作（絶対に不可）
- OS設定変更、レジストリ操作
- 任意コマンド実行（shell実行）
- 管理者権限の要求
- Git操作（必要なら将来）
- クラウド同期やアカウント管理（Gemini CLIの認証に委ねる）

## 5. 全体像（アーキテクチャ）
- GUI: Electron（Renderer）
- 制御層: Electron Main + IPC（Renderer↔Main）
- Gemini連携: Main から Gemini CLI を子プロセス起動して標準入出力をストリーミング
- ファイル操作: Main 側の「安全なファイルAPI」だけが実行
  - Renderer は直接ファイルへ触れない（IPC越しに要求のみ）
- ログ: ローカルに保存（ワークスペース内に限定、または AppData）

## 6. 重要要件（安全・安心）
### 6.1 権限モデル
- 操作対象はユーザー選択のワークスペースのみ
- パス検証は必ず Main 側で実施
- すべてのファイル操作は「許可された操作種別」だけに限定（allowlist）
- 危険操作は必ず追加確認（削除・大量変更・zip展開など）

### 6.2 ワークスペース脱出防止（パス正規化）
以下をすべて満たした場合のみ許可する:
- 入力パスを絶対パス化
- 実体パス（realpath）を取得して正規化
- realpath が workspace_realpath を prefix として含む
- シンボリックリンク/ジャンクションが絡む場合も realpath で判定
- Windowsのドライブ文字大小、区切り文字差異を吸収

### 6.3 実行前の承認（初心者向けUX）
- AIが提案した「操作プラン」をそのまま実行しない
- アプリは提案を「実行可能な操作列（FileOps）」に変換して表示
- 変更系は必ずプレビュー
  - テキスト: unified diff
  - バイナリ/画像: 書き換え禁止 or 置き換えの場合は要確認（v1は原則禁止推奨）
- ユーザーが「適用」を押したものだけ実行

### 6.4 禁止事項（v1）
- 外部コマンド実行（cmd/PowerShell含む）
- スクリプト生成→自動実行
- ネットワーク越しのファイル操作（SMBなど）は対象外扱い（将来検討）

## 7. チャット体験（主要フロー）
### 7.1 初回起動
1) ワークスペース選択（フォルダ選択ダイアログ）
2) Gemini CLI利用の説明（無料枠は上限がある可能性）
3) Gemini CLI 認証が必要な場合は案内（ブラウザでログイン等）

### 7.2 通常操作
1) ユーザーが依頼（例: 「このフォルダ内の.txtを全部UTF-8にして先頭に日付を入れて」）
2) アプリは「ワークスペース状況」を要約して Gemini に渡す（ファイル一覧/サイズ/拡張子など）
3) Gemini から提案（どのファイルに何をするか）
4) アプリが提案を「操作候補」に変換
5) 変更プレビュー（diff）
6) ユーザー承認 → 実行
7) 実行結果レポート（成功/失敗、対象、所要時間）

## 8. Gemini CLI 連携仕様
### 8.1 実行方式（推奨）
- Electron同梱のNode実行環境を利用し、Gemini CLIを子プロセス起動
- 標準出力を逐次UIへ表示（ストリーミング）

### 8.2 プロンプト設計（方針）
- Gemini には「提案」を作らせる
- 実行はアプリが行う
- Geminiへ渡す情報は最小限にし、必要ならユーザー承認のうえでファイル内容を送る
  - 例: 大きいファイルは先頭N行/抜粋のみ

### 8.3 入出力の扱い
- CLI出力はログとして保存可能（デフォルトOFFでもよい）
- 失敗時は標準エラーも表示

## 9. ファイル操作API（Main側）仕様
Rendererからの要求は、以下の型だけを受け付ける。

- list(path)
- readText(path, encodingHint?)
- writeText(path, content, mode: overwrite|append)
- mkdir(path)
- rename(src, dst)
- move(src, dst)
- copy(src, dst)
- delete(path, recursive?)
- searchName(glob/substring)
- searchText(query, options)
- zipCreate(sources[], zipPath)
- zipExtract(zipPath, destDir)

共通ルール:
- すべて workspace 内に制限
- すべての操作は事前に「dry-run」で影響範囲を算出できること（削除・zip展開も含む）
- 破壊的操作は二段階確認（例: “10個削除します。続行？”）

## 10. UI要件
- チャット画面（会話ログ）
- 左（または右）にファイルツリー（ワークスペースのみ）
- 変更プレビュー（diff）ペイン
- 実行キュー（これから適用される操作一覧）
- ボタン: 「プレビュー」「適用」「キャンセル」「元に戻す（可能なら）」

UI設計方針:
- “何が起きるか”を常に見える化
- 初心者に怖い言葉（コマンド、パス、権限）を極力隠し、必要時だけ説明

## 11. ログ・監査
- 実行した操作を時系列で保存（任意）
- 保存先は以下いずれか
  - ワークスペース内の `.gemini-gui-logs/`
  - もしくは `%APPDATA%\GeminiGuiWrapper\logs\`
- ログには個人情報や機密を含む可能性があるため、共有前の注意喚起を表示

## 12. エラーハンドリング
- Gemini CLI が未設定/失敗の場合
  - 認証案内、再試行導線
- ファイル操作失敗
  - 何が原因か（権限/存在しない/パス外/ロック中）を平易に表示
- 大量操作
  - 途中経過を表示し、中断可能にする

## 13. 配布・インストール要件（GitHub）
- GitHub Releases にて配布
- Windows向けインストーラ（.exe）を提供
- 署名は将来検討（SmartScreen対策として推奨）
- 依存物（Node/Python等）をユーザーに別途入れさせない方針
- 初回起動時にGemini CLIが必要な場合は、アプリ内で完結してセットアップ（同梱 or 初回ダウンロード）

## 14. 開発マイルストーン
### M0（動く最小）
- ワークスペース選択
- チャットUI
- Gemini CLI起動・出力表示
- list/read のみ

### M1（初心者が便利と感じる）
- write/rename/move/copy
- diffプレビュー
- 破壊操作の確認

### v1（公開）
- delete/zip/searchText
- ログ
- 例示テンプレ（よくある依頼をボタン化）

## 15. 受け入れ条件（v1）
- ワークスペース外へのアクセスが100%ブロックされる
- 変更系は必ずプレビューとユーザー承認を通る
- 初心者が「インストール→起動→フォルダ選択→簡単な操作」まで迷わず到達できる
- GitHub Releases からダウンロードしてインストールできる

## 16. 追加検討項目（要詳細設計）

### 16.1 Gemini CLI 連携詳細
- [ ] CLI 出力フォーマット（JSON / テキスト）の仕様定義
- [ ] 「提案」から「操作候補（FileOps）」への変換ロジック
- [ ] レート制限・タイムアウト・リトライポリシー
- [ ] オフライン時・認証トークン期限切れ時の UX

### 16.2 Undo（元に戻す）機能
- [ ] 対応範囲の明確化（どの操作まで Undo 可能か）
- [ ] バックアップ戦略（一時フォルダへのコピー / スナップショット）
- [ ] バックアップの保持期間・自動削除ポリシー

### 16.3 並行処理・排他制御
- [ ] 複数ファイル同時操作時のロック戦略
- [ ] 外部からのファイル変更検知と競合解決

### 16.4 文字エンコーディング
- [ ] 自動判定ロジック（BOM / ヒューリスティクス）
- [ ] 対応エンコーディング一覧（UTF-8, Shift_JIS, EUC-JP 等）
- [ ] 判定失敗時のフォールバック動作

### 16.5 パフォーマンス要件
- [ ] 処理対象ファイル数の上限（警告閾値 / 強制制限）
- [ ] 単一ファイルサイズの上限
- [ ] 大量操作時の進捗表示・中断機能

### 16.6 テスト戦略
- [ ] 単体テスト方針（パス検証、ファイル操作 API）
- [ ] E2E テストシナリオ（ワークスペース脱出防止、承認フロー）
- [ ] セキュリティテスト（シンボリックリンク攻撃等）

---
更新履歴:
- 2026-02-03 追加検討項目（セクション16）を追加
- 2026-02-03 初版
