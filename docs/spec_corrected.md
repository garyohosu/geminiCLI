# Gemini CLI GUI Wrapper（Windows向け）仕様書（MVP〜v1）

## 0. 前提知識

### Gemini CLIとは
Google が提供する**無料のAIエージェント型コーディングツール**。
- ローカル環境で動作
- ファイルの読み書き、コマンド実行が可能
- プロジェクトフォルダを読み込んでコード生成・テスト実行まで対応
- **Claude Cowork と同等の機能を無料で利用可能**

参考: [Gemini CLIの使い方（note記事）](https://note.com/hantani/n/n461ce66e0807)

### 料金
- **Gemini API 無料プラン**: 1日1500リクエスト、1分間15リクエストまで無料
- 一般ユーザーには十分な無料枠

---

## 1. 目的

**「Claude Cowork」の非プログラマー版**を、Windows向けに作る。

プログラマー以外のアマチュアユーザー（事務職、教師、フリーランス等）が、AIエージェントに自然言語で「お願い」するだけで、実際にローカルのファイル操作を**安全に自動実行**してもらえるデスクトップアプリ。

### 実現する体験
- ❌ ChatGPT: 「こうすればいいですよ」（提案するだけ）
- ✅ このアプリ: 「やっておきました」（実際に実行）

### 差別化ポイント
1. **無料**: Gemini CLIを使用（無料で1日1500リクエスト）
2. **安全**: ワークスペース内のみ操作、破壊的操作は承認必須
3. **簡単**: CLI知識不要、GUIでチャットするだけ
4. **エージェント動作**: 会話から必要な操作を自動判断・実行

---

## 2. 想定ユーザー

### メインターゲット
- **プログラマー以外のアマチュア**（事務職、教師、個人事業主、学生等）
- CLIやコマンドプロンプトを使ったことがない人
- AI課金を避けたいが、AIの力は借りたい人

### ユースケース例
| ユーザー | 利用シーン |
|----------|------------|
| 事務職 | 「先月の請求書PDFを全部『202501_請求書』フォルダに移動して」 |
| 教師 | 「生徒の提出レポート50個から、名前だけ抜き出してCSVにして」 |
| フリーランス | 「写真フォルダから2024年12月の写真だけ選んで新しいフォルダに」 |
| ブロガー | 「draftフォルダの記事を全部読んで、タイトル一覧をMarkdownで作って」 |
| 学生 | 「レポートのPDFファイルを全部リネームして、提出日を先頭に付けて」 |

**重要**: プログラマーは対象外（VSCode拡張やCLI直接使用で十分）

---

## 3. スコープ

### 3.1 対応OS
- Windows 10 / 11（64bit）

### 3.2 対象フォルダ制限（最重要）
- ユーザーがアプリ上で選択した「**ワークスペースフォルダ**」配下のみ操作可能
- ワークスペース外のパスは一切アクセス不可（読み取り・書き込み・列挙・削除すべて禁止）
- シンボリックリンク / ジャンクションでの脱出を防ぐ（パス正規化で対応）

### 3.3 対応するファイル操作（指定フォルダ内のみ）
- **参照**: ファイル一覧、内容表示（テキスト/バイナリ判定）
- **作成**: 新規ファイル/フォルダ作成
- **更新**: テキスト編集、検索/置換、追記、移動、リネーム
- **削除**: ファイル/フォルダ削除（確認必須）
- **複製**: コピー
- **圧縮/展開**: zip の作成・展開（確認必須）
- **検索**: ファイル名検索、内容検索（簡易正規表現は任意）
- **差分**: テキストファイルはdiff表示（必須）
- **整理**: 日付・拡張子・名前でのグルーピング

※ 実行ファイルの実行（.exe/.bat/.ps1 等）や外部コマンド実行は v1 では禁止（後述の安全設計）

---

## 4. 非スコープ（v1ではやらない）

### 絶対にやらない
- ワークスペース外の操作
- OS設定変更、レジストリ操作
- 管理者権限の要求
- 外部ネットワークアクセス（API通信除く）

### v2以降で検討
- 任意コマンド実行（サンドボックス内）
- Git操作
- クラウド同期（Google Drive、Dropbox等）
- 画像編集・変換
- Office文書の高度な編集

---

## 5. 全体像（アーキテクチャ）

### 5.1 技術スタック
```
┌─────────────────────────────────────┐
│  Electron Renderer (GUI)            │
│  - チャット画面（Gemini CLI出力表示）│
│  - ファイルツリー表示                │
│  - 変更プレビュー（diff）            │
└──────────────┬──────────────────────┘
               │ IPC
┌──────────────▼──────────────────────┐
│  Electron Main (制御層)              │
│  - Gemini CLI の子プロセス管理       │
│  - 安全なファイルAPI（パス検証）     │
│  - 操作ログ記録                      │
│  - 標準入出力の傍受・監視            │
└──────────────┬──────────────────────┘
               │ spawn/stdin/stdout
┌──────────────▼──────────────────────┐
│  Gemini CLI (子プロセス)             │
│  - AIエージェント機能                │
│  - ファイル読み書き・コマンド実行    │
│  - ワークスペースフォルダ内で動作    │
└─────────────────────────────────────┘
```

### 5.2 重要な設計方針

**Gemini CLIの直接実行を制限する:**
- Gemini CLIが提案するファイル操作を**自動実行させない**
- Main側で標準出力を監視し、操作内容をパースして承認UIを表示
- ユーザー承認後、Main側の安全なファイルAPIで実行
- これにより、ワークスペース外への脱出を完全にブロック

**または、Gemini CLIを「提案専用」として使う:**
- Gemini CLIに `--yolo` フラグを付けずに起動（対話モード）
- Geminiに「提案だけ」させる
- 実行はElectron Main側が行う

---

## 6. 重要要件（安全・安心）

### 6.1 権限モデル
- 操作対象はユーザー選択のワークスペースのみ
- パス検証は必ず Main 側で実施
- すべてのファイル操作は「許可された操作種別」だけに限定（allowlist）
- 危険操作は必ず追加確認（削除・大量変更・zip展開など）

### 6.2 ワークスペース脱出防止（パス正規化）

以下をすべて満たした場合のみ許可する:

```javascript
function validatePath(inputPath, workspace) {
  // 1. 絶対パス化
  const absPath = path.resolve(workspace, inputPath);
  
  // 2. 実体パス取得（シンボリックリンク解決）
  const realPath = fs.realpathSync(absPath);
  const workspaceReal = fs.realpathSync(workspace);
  
  // 3. ワークスペース内かチェック
  if (!realPath.startsWith(workspaceReal + path.sep)) {
    throw new Error("PATH_OUTSIDE_WORKSPACE");
  }
  
  return realPath;
}
```

- シンボリックリンク/ジャンクションが絡む場合も realpath で判定
- Windowsのドライブ文字大小、区切り文字差異（`\` vs `/`）を吸収

### 6.3 実行前の承認（初心者向けUX）

#### 基本フロー
1. Gemini CLIが操作を提案
2. アプリが標準出力を監視して操作内容を検出
3. 「実行可能な操作列（FileOps）」に変換して表示
4. 変更系は必ずプレビュー
   - テキスト: unified diff
   - 削除: 対象ファイル一覧
   - 移動: before/after のパス一覧
5. ユーザーが「適用」を押したものだけ実行

#### 承認画面例
```
AIが以下の操作を提案しています:

📝 変更: report.txt
   - 3行目: 「2024年」→「2025年」
   [差分を見る]

📂 移動: 25個のファイル
   photo_001.jpg → 2024-12/photo_001.jpg
   photo_002.jpg → 2024-12/photo_002.jpg
   ... 他23個
   [詳細を見る]

[すべて実行] [個別選択] [キャンセル]
```

### 6.4 禁止事項（v1）
- 外部コマンド実行（cmd/PowerShell含む）
- スクリプト生成→自動実行
- `.exe`, `.bat`, `.ps1` の実行
- ネットワーク越しのファイル操作（SMBなど）は対象外扱い（将来検討）

---

## 7. Gemini CLI 連携仕様

### 7.1 実行方式

#### Option A: 提案専用モード（推奨）
```javascript
// Gemini CLIを対話モードで起動（--yolo なし）
const geminiProcess = spawn('gemini', ['--workspace', workspacePath], {
  cwd: workspacePath,
  env: { ...process.env }
});

// 標準出力を監視
geminiProcess.stdout.on('data', (data) => {
  // Geminiの提案をパース
  const operations = parseGeminiOutput(data);
  
  // 承認UIを表示
  showApprovalDialog(operations);
});

// 承認後、Main側のファイルAPIで実行
async function executeApproved(operations) {
  for (const op of operations) {
    await safeFileAPI.execute(op); // パス検証済み
  }
}
```

#### Option B: モニタリングモード
- Gemini CLIに `--yolo` フラグで自動実行させる
- ファイルシステムAPIをフックして監視（高度）
- ワークスペース外へのアクセスをブロック

**v1では Option A を推奨**（実装がシンプル、安全性が高い）

### 7.2 プロンプト設計（方針）

Gemini CLIに渡すシステムプロンプト:

```
あなたはファイル整理アシスタントです。
ユーザーのリクエストに基づいて、以下のフォルダ内のファイル操作を提案してください。

ワークスペース: {workspacePath}

制約:
- このフォルダの外にはアクセスできません
- 提案のみを行い、実行は人間が承認してから行います
- 変更内容は具体的に説明してください（どのファイルをどう変更するか）

利用可能な操作:
- ファイルの読み込み
- ファイルの作成・編集
- ファイルの移動・リネーム
- ファイルの削除（慎重に）
- フォルダの作成
```

### 7.3 出力のパース

Gemini CLIの出力から操作内容を抽出:

```javascript
function parseGeminiOutput(output) {
  // Geminiが提案する操作を検出
  // 例: "I will move photo_001.jpg to 2024-12/photo_001.jpg"
  
  const operations = [];
  
  // 正規表現やキーワードで検出
  if (output.includes('move')) {
    operations.push({
      type: 'move',
      src: extractSourcePath(output),
      dst: extractDestPath(output)
    });
  }
  
  return operations;
}
```

---

## 8. チャット体験（主要フロー）

### 8.1 初回起動
1. **ワークスペース選択**（フォルダ選択ダイアログ）
2. **Gemini CLI セットアップ**
   - 未インストールの場合: `npm install -g @google/gemini-cli` を案内
   - または、アプリに同梱（ライセンス確認が必要）
3. **Google認証**（初回のみ）
   - ブラウザでGoogleアカウントログイン
4. **使い方説明**
   - 「このフォルダ内のファイルを整理できます」
   - 「無料で1日1500回まで使えます」

### 8.2 通常操作フロー

```
1. ユーザー
   「このフォルダ内の.txtを全部UTF-8にして先頭に日付を入れて」
        ↓
2. アプリ→Gemini CLI
   - 現在のワークスペース状況を要約（ファイル一覧/サイズ/拡張子）
   - ユーザーのリクエストと共に送信
        ↓
3. Gemini CLI
   「承知しました。まず現在のファイルを確認します...」
   - ファイル一覧取得
   - 各ファイルのエンコーディング確認
   - 変更内容を提案
        ↓
4. アプリ
   - Geminiの出力をパース
   - 「5個の.txtファイルをUTF-8に変換し、先頭に日付を追加」
   - 変更プレビュー（diff）表示
        ↓
5. ユーザー承認
   [実行する] ボタンをクリック
        ↓
6. アプリ（Main側）
   - パス検証
   - 安全なファイルAPIで実行
   - 進捗表示
        ↓
7. 完了報告
   「5個のファイルを処理しました（成功: 5、失敗: 0）」
```

---

## 9. UI要件

### 9.1 メイン画面構成

```
┌───────────────────────────────────────────────────┐
│ 📁 ワークスペース: C:\Users\...\Documents          │
│ 💬 無料枠: 今日 45/1500 リクエスト使用            │
├──────────┬────────────────────────────────────────┤
│          │  💬 チャット画面                       │
│  ファイル │                                        │
│  ツリー  │  ユーザー「写真を日付で整理して」      │
│          │                                        │
│  📁 2024 │  🤖 Gemini「承知しました。             │
│  📁 2025 │     現在のファイルを確認します...」    │
│  📄 a.txt│                                        │
│  📄 b.txt│  🤖「25個の写真ファイルを発見しました」│
│          │                                        │
│          │  📋 操作提案                           │
│          │  ┌─────────────────────────────┐     │
│          │  │ 📂 移動: 25個のファイル      │     │
│          │  │ photo_*.jpg → 2024-12/      │     │
│          │  │                              │     │
│          │  │ [詳細を見る] [実行する]     │     │
│          │  └─────────────────────────────┘     │
│          │                                        │
│          │  [メッセージ入力欄]                    │
└──────────┴────────────────────────────────────────┘
```

### 9.2 変更プレビュー画面

```
変更プレビュー: report.txt
─────────────────────────────────────────
  1  2024年度 売上報告書
  2  
- 3  作成日: 2024-01-15
+ 3  作成日: 2025-01-15
  4  
  5  ## 概要

[戻る] [この変更を実行]
```

### 9.3 操作確認ダイアログ

```
┌─────────────────────────────────────┐
│ 以下の操作を実行しますか？          │
├─────────────────────────────────────┤
│ 📂 移動: 25個のファイル             │
│                                     │
│ photo_001.jpg → 2024-12/photo_001.jpg│
│ photo_002.jpg → 2024-12/photo_002.jpg│
│ ... 他23個                          │
│                                     │
│ [詳細リストを見る]                  │
│                                     │
│ [実行する] [キャンセル]             │
└─────────────────────────────────────┘
```

---

## 10. 配布・インストール要件

### 10.1 配布方法
- **GitHub Releases** にて配布
- インストーラー形式: `GeminiCLI-GUI-Setup-1.0.0.exe`
- 自動更新機能（electron-updater）

### 10.2 インストーラーに含めるもの
- Electron + Node.js（同梱）
- アプリ本体

### 10.3 Gemini CLIのセットアップ戦略

#### Option A: 同梱（推奨）
- `@google/gemini-cli` をアプリに同梱
- ライセンス確認が必要（Apache 2.0等）
- ユーザーは何もインストール不要

#### Option B: 初回自動インストール
- 初回起動時に `npm install -g @google/gemini-cli` を自動実行
- Node.jsのパス設定が必要

#### Option C: 手動インストール案内
- ユーザーに手動でインストールしてもらう
- 説明画面で手順を表示

**v1では Option A を推奨**（ユーザー体験が最良）

### 10.4 システム要件
- Windows 10/11 64bit
- メモリ: 4GB以上推奨
- ストレージ: 300MB（インストールサイズ）
- インターネット接続（Gemini API通信用）

---

## 11. 開発マイルストーン

### M0（技術検証）- 2週間
- [ ] Gemini CLI の子プロセス起動確認
- [ ] 標準入出力の監視・パース
- [ ] Electron + IPC の基本実装
- [ ] パス検証ロジックの実装とテスト
- [ ] 簡単なread/write操作

### M1（MVP）- 4週間
- [ ] チャットUI実装（Gemini CLI出力のストリーミング表示）
- [ ] ファイルツリー表示
- [ ] list/read/write/move 操作
- [ ] 承認フロー（基本版）
- [ ] diff表示

### M2（v1に向けて）- 6週間
- [ ] delete/copy/zip操作
- [ ] 操作ログ
- [ ] エラーハンドリング強化
- [ ] セキュリティテスト（パス脱出防止）
- [ ] 大量操作時の進捗表示・中断機能

### v1.0リリース（+2週間）
- [ ] インストーラー作成
- [ ] ドキュメント整備（README、使い方ガイド）
- [ ] GitHub Releases 公開
- [ ] 使い方動画作成（YouTube等）
- [ ] 紹介記事執筆（note等）

---

## 12. 受け入れ条件（v1）

以下を全て満たすこと:

- [ ] ワークスペース外への操作が100%ブロックされる
- [ ] シンボリックリンク経由の脱出が防げる
- [ ] 破壊的操作（削除・上書き）は必ず承認が必要
- [ ] 初心者が「インストール→起動→フォルダ選択→使い始め」まで30分以内で到達
- [ ] Gemini CLIのエージェント機能が正しく動作する
- [ ] 日本語で自然な会話ができる
- [ ] 変更プレビュー（diff）が正しく表示される
- [ ] GitHub Releases からインストーラーがダウンロードできる
- [ ] セキュリティテストに合格（パス脱出攻撃への耐性）

---

## 13. 追加検討項目（要詳細設計）

### 13.1 Gemini CLI 連携詳細
- [ ] CLI 出力フォーマットの仕様定義（テキスト / JSON）
- [ ] 「提案」から「操作候補（FileOps）」への変換ロジック
- [ ] レート制限・タイムアウト・リトライポリシー
- [ ] オフライン時・認証トークン期限切れ時の UX
- [ ] 無料枠の残量表示（1日1500リクエスト）

### 13.2 Undo（元に戻す）機能
- [ ] 対応範囲の明確化（どの操作まで Undo 可能か）
- [ ] バックアップ戦略（`.gemini-gui-backups/` にスナップショット保存）
- [ ] バックアップの保持期間・自動削除ポリシー（最大10世代等）

### 13.3 並行処理・排他制御
- [ ] 複数ファイル同時操作時のロック戦略
- [ ] 外部からのファイル変更検知と競合解決

### 13.4 文字エンコーディング
- [ ] 自動判定ロジック（BOM / chardet等）
- [ ] 対応エンコーディング一覧（UTF-8, Shift_JIS, EUC-JP 等）
- [ ] 判定失敗時のフォールバック動作（バイナリ扱い）

### 13.5 パフォーマンス要件
- [ ] 処理対象ファイル数の上限（警告閾値: 100個、強制制限: 1000個等）
- [ ] 単一ファイルサイズの上限（100MB等）
- [ ] 大量操作時の進捗表示・中断機能

### 13.6 テスト戦略
- [ ] 単体テスト方針（パス検証、ファイル操作 API）
- [ ] E2E テストシナリオ（ワークスペース脱出防止、承認フロー）
- [ ] セキュリティテスト（シンボリックリンク攻撃、パストラバーサル等）

---

## 14. よくある質問（FAQ）

### Q1: Gemini CLIは本当に無料？
**A**: はい。Gemini API の無料枠（1日1500リクエスト）内で使えます。一般的な利用では十分です。

### Q2: ChatGPTとの違いは？
**A**: ChatGPTは提案するだけですが、このアプリは実際にファイル操作を実行します。Claude Coworkの非プログラマー版です。

### Q3: プログラマーも使える？
**A**: 使えますが、プログラマーならGemini CLIを直接使う方が便利です。このアプリは非プログラマー向けです。

### Q4: Macでは使えない？
**A**: v1はWindows専用です。需要があればMac/Linux版も検討します。

### Q5: セキュリティは大丈夫？
**A**: ワークスペース外へのアクセスを完全にブロックしています。すべてのパスを検証し、シンボリックリンク経由の脱出も防いでいます。

### Q6: オフラインでは使えない？
**A**: Gemini APIがクラウド側で動作するため、インターネット接続が必要です。

---

## 15. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Gemini API無料枠の制限 | ユーザーが使えなくなる | 使用量表示、有料プラン案内 |
| パス検証の脆弱性 | ワークスペース外へ脱出 | 徹底的なセキュリティテスト、realpath使用 |
| 誤操作での重要ファイル削除 | データ消失 | 削除前の確認、自動バックアップ |
| Gemini CLIの出力パース失敗 | 操作実行できない | フォールバック処理、手動実行オプション |
| SmartScreen警告 | インストールされない | コード署名（将来）、README で説明 |
| 大量ファイル操作でのフリーズ | アプリが応答しない | 非同期処理、進捗表示、中断機能 |

---

## 付録A: 参考リンク

- [Gemini CLIの使い方（note記事）](https://note.com/hantani/n/n461ce66e0807)
- [Gemini CLI 公式リポジトリ](https://github.com/google-gemini/gemini-cli)
- [Gemini API ドキュメント](https://ai.google.dev/docs)
- [Electron Security ベストプラクティス](https://www.electronjs.org/docs/latest/tutorial/security)

---

更新履歴:
- 2026-02-03 Gemini CLIがエージェント機能を持つことを確認、仕様を修正
- 2026-02-03 ターゲットユーザーを「プログラマー以外のアマチュア」に明確化
- 2026-02-03 無料プランの詳細を追加（1日1500リクエスト）
- 2026-02-03 初版
